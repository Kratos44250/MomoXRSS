<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>MomoXRss</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
    h1 { color: #333; }
    input, button, select { margin: 5px 0; padding: 8px; width: 100%; }
    .flux { background: #fff; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
    .flux button { margin-top: 5px; margin-right: 8px; }
    .hint { font-size: 12px; color: #666; }
    .bad { color: #b00; font-weight: bold; }
    .ok { color: #0a0; font-weight: bold; }
  </style>
</head>
<body>
  <h1>üì∞ MomoXRss</h1>

  <h2>‚ûï Ajouter un flux RSS</h2>
  <form id="addForm">
    <input type="text" id="rssUrl" placeholder="URL du flux RSS" required>
    <input type="text" id="discordTarget" placeholder="ID du channel forum Discord (ex: 1422270965198491918)" required>
    <div class="hint">‚ö†Ô∏è Utilise uniquement l‚ÄôID num√©rique du channel, pas l‚ÄôURL compl√®te. Si tu colles une URL, elle sera automatiquement convertie en ID.</div>
    <input type="number" id="interval" placeholder="Intervalle en ms (ex: 3600000 = 1h)">
    <button type="submit">Ajouter</button>
  </form>

  <h2>üß™ Tester un flux RSS</h2>
  <form id="testForm">
    <input type="text" id="testUrl" placeholder="URL du flux RSS √† tester" required>
    <button type="submit">Tester</button>
    <div id="testResult"></div>
  </form>

  <h2>üìã Flux enregistr√©s</h2>
  <div id="fluxList"></div>

  <h2>‚úçÔ∏è Envoyer un article personnalis√©</h2>
  <form id="manualForm">
    <input type="text" id="manualTitle" placeholder="Titre de l'article" required>
    <input type="text" id="manualLink" placeholder="Lien de l'article" required>
    <input type="text" id="manualDiscord" placeholder="ID du channel forum Discord" required>
    <button type="submit">Envoyer</button>
  </form>

  <script>
    // Extrait l'ID de channel si une URL Discord est coll√©e, sinon retourne la valeur trim√©e
    function normalizeDiscordTarget(input) {
      if (!input) return '';
      const trimmed = String(input).trim();
      if (trimmed.includes('discord.com/channels/')) {
        // format: https://discord.com/channels/<guildId>/<channelId>
        const parts = trimmed.split('/').filter(Boolean);
        const channelId = parts[parts.length - 1];
        return channelId;
      }
      return trimmed;
    }

    function isValidDiscordId(id) {
      return /^[0-9]{16,21}$/.test(id); // la plupart des IDs font 18-19 chiffres
    }

    async function safeJson(res) {
      try { return await res.json(); } catch { return null; }
    }
    async function safeText(res) {
      try { return await res.text(); } catch { return ''; }
    }

    async function loadFlux() {
      const res = await fetch('/list');
      if (!res.ok) {
        alert('Impossible de charger la liste des flux: ' + res.status);
        return;
      }
      const fluxes = await res.json();
      const container = document.getElementById('fluxList');
      container.innerHTML = '';
      fluxes.forEach(f => {
        const normalized = normalizeDiscordTarget(f.discordTarget);
        const valid = isValidDiscordId(normalized);
        const div = document.createElement('div');
        div.className = 'flux';
        div.innerHTML = `
          <strong>${f.rssUrl}</strong><br>
          Channel: ${f.discordTarget}
          ${valid ? '<span class="ok">[ID OK]</span>' : '<span class="bad">[ID incorrect ‚Äî URL d√©tect√©e]</span>'}<br>
          Intervalle : ${f.interval} ms<br>
          √âtat : ${f.active ? '‚úÖ Actif' : '‚õî D√©sactiv√©'}<br>
          <div>
            <button onclick="sendLatest('${f.rssUrl}')">üß™ Envoyer dernier article</button>
            <button onclick="changeInterval('${f.rssUrl}')">‚è±Ô∏è Modifier fr√©quence</button>
            <button onclick="editFlux('${f.rssUrl}')">‚úèÔ∏è Modifier flux</button>
            <button onclick="toggleFlux('${f.rssUrl}')">${f.active ? '‚è∏Ô∏è D√©sactiver' : '‚ñ∂Ô∏è Activer'}</button>
            <button onclick="deleteFlux('${f.rssUrl}')">üóëÔ∏è Supprimer</button>
            ${!valid ? `<button onclick="fixTarget('${f.rssUrl}','${normalized}')">üõ†Ô∏è Corriger ID</button>` : ''}
          </div>
        `;
        container.appendChild(div);
      });
    }

    // Envoie en se basant sur le flux enregistr√© (et normalis√©) pour √©viter les mismatches
    async function sendLatest(rssUrl) {
      // R√©cup√®re la liste des flux et trouve celui correspondant
      const listRes = await fetch('/list');
      if (!listRes.ok) {
        alert('Impossible de r√©cup√©rer les flux: ' + listRes.status);
        return;
      }
      const fluxes = await listRes.json();
      const flux = fluxes.find(f => f.rssUrl === rssUrl);
      if (!flux) {
        alert('Flux introuvable');
        return;
      }
      const target = normalizeDiscordTarget(flux.discordTarget);
      if (!isValidDiscordId(target)) {
        alert("discordTarget invalide ‚Äî corrige l'ID du channel pour ce flux.");
        return;
      }

      const resp = await fetch('/send-latest', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ rssUrl, discordTarget: target })
      });

      if (!resp.ok) {
        const msg = await safeText(resp);
        alert('√âchec de l‚Äôenvoi: ' + (msg || resp.status));
        return;
      }
      alert('Dernier article envoy√© sur Discord');
    }

    async function changeInterval(rssUrl) {
      const interval = prompt('Nouvel intervalle en ms :');
      if (!interval) return;
      const iv = parseInt(interval);
      if (Number.isNaN(iv) || iv < 60000) {
        alert('Intervalle invalide (min recommand√©: 60000 ms)');
        return;
      }
      const resp = await fetch('/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ rssUrl, interval: iv })
      });
      if (!resp.ok) {
        const msg = await safeText(resp);
        alert('√âchec mise √† jour: ' + (msg || resp.status));
        return;
      }
      alert('Intervalle mis √† jour');
      loadFlux();
    }

    async function editFlux(rssUrl) {
      const newRssUrl = prompt('Nouvelle URL RSS (laisser vide pour ne pas changer) :');
      const discordTargetInput = prompt('Nouvel ID du forum Discord (laisser vide pour ne pas changer) :');
      const intervalInput = prompt('Nouvel intervalle en ms (laisser vide pour ne pas changer) :');

      const payload = { rssUrl };

      if (newRssUrl) payload.newRssUrl = newRssUrl;
      if (discordTargetInput) {
        const target = normalizeDiscordTarget(discordTargetInput);
        if (!isValidDiscordId(target)) {
          alert("discordTarget invalide ‚Äî fournis l'ID num√©rique du channel, pas une URL.");
          return;
        }
        payload.discordTarget = target;
      }
      if (intervalInput) {
        const iv = parseInt(intervalInput);
        if (Number.isNaN(iv) || iv < 60000) {
          alert('Intervalle invalide (min recommand√©: 60000 ms)');
          return;
        }
        payload.interval = iv;
      }

      const resp = await fetch('/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!resp.ok) {
        const msg = await safeText(resp);
        alert('√âchec mise √† jour: ' + (msg || resp.status));
        return;
      }

      alert('Flux mis √† jour');
      loadFlux();
    }

    async function toggleFlux(rssUrl) {
      const res = await fetch('/toggle', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ rssUrl })
      });
      if (!res.ok) {
        const msg = await safeText(res);
        alert('√âchec toggle: ' + (msg || res.status));
        return;
      }
      const data = await res.json();
      alert(data.active ? 'Flux activ√©' : 'Flux d√©sactiv√©');
      loadFlux();
    }

    async function deleteFlux(rssUrl) {
      if (!confirm('Confirmer la suppression de ce flux ?')) return;
      const resp = await fetch('/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ rssUrl })
      });
      if (!resp.ok) {
        const msg = await safeText(resp);
        alert('√âchec suppression: ' + (msg || resp.status));
        return;
      }
      alert('Flux supprim√©');
      loadFlux();
    }

    // Corrige en base un discordTarget au mauvais format pour le flux donn√©
    async function fixTarget(rssUrl, normalized) {
      if (!isValidDiscordId(normalized)) {
        alert("Impossible de corriger: l'ID normalis√© n'est pas valide.");
        return;
      }
      const resp = await fetch('/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ rssUrl, discordTarget: normalized })
      });
      if (!resp.ok) {
        const msg = await safeText(resp);
        alert('√âchec correction: ' + (msg || resp.status));
        return;
      }
      alert('discordTarget corrig√©');
      loadFlux();
    }

    document.getElementById('addForm').onsubmit = async e => {
      e.preventDefault();
      const rssUrl = document.getElementById('rssUrl').value.trim();
      const discordTargetRaw = document.getElementById('discordTarget').value;
      const discordTarget = normalizeDiscordTarget(discordTargetRaw);
      const intervalStr = document.getElementById('interval').value;
      const interval = intervalStr ? parseInt(intervalStr) : undefined;

      if (!isValidDiscordId(discordTarget)) {
        alert("discordTarget invalide ‚Äî fournis l'ID num√©rique du channel, pas une URL.");
        return;
      }
      if (interval !== undefined && (Number.isNaN(interval) || interval < 60000)) {
        alert('Intervalle invalide (min recommand√©: 60000 ms)');
        return;
      }

      const resp = await fetch('/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ rssUrl, discordTarget, interval })
      });

      if (!resp.ok) {
        const msg = await safeText(resp);
        alert('√âchec ajout: ' + (msg || resp.status));
        return;
      }

      alert('Flux ajout√©');
      document.getElementById('addForm').reset();
      loadFlux();
    };

    document.getElementById('testForm').onsubmit = async e => {
      e.preventDefault();
      const testUrl = document.getElementById('testUrl').value.trim();
      const res = await fetch('/test', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ rssUrl: testUrl })
      });
      const resultDiv = document.getElementById('testResult');
      if (!res.ok) {
        const msg = await safeText(res);
        resultDiv.innerHTML = `<span class="bad">Test √©chou√©: ${msg || res.status}</span>`;
        return;
      }
      const data = await res.json();
      resultDiv.innerHTML = `
        <strong>${data.title || 'Flux'}</strong><br>
        <ul>${(data.items || []).map(i => `<li>${i.title}</li>`).join('')}</ul>
      `;
    };

    document.getElementById('manualForm').onsubmit = async e => {
      e.preventDefault();
      const title = document.getElementById('manualTitle').value.trim();
      const link = document.getElementById('manualLink').value.trim();
      const discordTargetRaw = document.getElementById('manualDiscord').value;
      const discordTarget = normalizeDiscordTarget(discordTargetRaw);

      if (!isValidDiscordId(discordTarget)) {
        alert("discordTarget invalide ‚Äî fournis l'ID num√©rique du channel, pas une URL.");
        return;
      }

      const resp = await fetch('/manual', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, link, discordTarget })
      });

      if (!resp.ok) {
        const msg = await safeText(resp);
        alert('√âchec envoi: ' + (msg || resp.status));
        return;
      }

      alert('Article envoy√©');
      document.getElementById('manualForm').reset();
    };

    loadFlux();
  </script>
</body>
</html>
